# Extended Joust - Complete Specification

## Part 5: Project Structure & Implementation Notes

---

## ğŸ“ Frontend Project Structure

```
client/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx                    # Entry point
â”‚   â”œâ”€â”€ App.tsx                     # Root component with router
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ JoinView.tsx            # /join - Name entry + join lobby
â”‚   â”‚   â”œâ”€â”€ PlayerView.tsx          # /player - Main controller interface
â”‚   â”‚   â””â”€â”€ DashboardView.tsx       # /dashboard - Admin scoreboard
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ player/
â”‚   â”‚   â”‚   â”œâ”€â”€ PlayerNumber.tsx           # Giant number display
â”‚   â”‚   â”‚   â”œâ”€â”€ HealthBackground.tsx       # Colored bg based on health
â”‚   â”‚   â”‚   â”œâ”€â”€ StatusEffects.tsx          # Active effects display
â”‚   â”‚   â”‚   â”œâ”€â”€ TargetDisplay.tsx          # "Target: #3" indicator
â”‚   â”‚   â”‚   â””â”€â”€ ConnectionStatus.tsx       # Connected/reconnecting dot
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”œâ”€â”€ PlayerGrid.tsx             # Grid of player cards
â”‚   â”‚   â”‚   â”œâ”€â”€ PlayerCard.tsx             # Individual player status
â”‚   â”‚   â”‚   â”œâ”€â”€ Scoreboard.tsx             # Points leaderboard
â”‚   â”‚   â”‚   â”œâ”€â”€ GameState.tsx              # Round/mode/timer display
â”‚   â”‚   â”‚   â”œâ”€â”€ EventFeed.tsx              # Live event feed
â”‚   â”‚   â”‚   â””â”€â”€ AdminControls.tsx          # Start/stop/mode selection
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ shared/
â”‚   â”‚       â”œâ”€â”€ Logo.tsx
â”‚   â”‚       â”œâ”€â”€ LoadingSpinner.tsx
â”‚   â”‚       â””â”€â”€ ErrorBoundary.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useSocket.ts               # Socket.IO connection management
â”‚   â”‚   â”œâ”€â”€ useAccelerometer.ts        # Motion sensor access + throttling
â”‚   â”‚   â”œâ”€â”€ useWakeLock.ts             # Keep screen awake
â”‚   â”‚   â”œâ”€â”€ useFullscreen.ts           # Fullscreen mode toggle
â”‚   â”‚   â”œâ”€â”€ useAudio.ts                # Sound effects player
â”‚   â”‚   â”œâ”€â”€ useReconnect.ts            # Auto-reconnection with token
â”‚   â”‚   â””â”€â”€ useGameState.ts            # Zustand store wrapper
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ socket.ts                  # Socket.IO client setup + event handlers
â”‚   â”‚   â”œâ”€â”€ api.ts                     # HTTP API calls (REST endpoints)
â”‚   â”‚   â”œâ”€â”€ audio.ts                   # Audio manager (preload, play, queue)
â”‚   â”‚   â””â”€â”€ accelerometer.ts           # Motion sensor handler + normalization
â”‚   â”‚
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â””â”€â”€ gameStore.ts               # Zustand global state
â”‚   â”‚
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ player.types.ts            # Player, health, status types
â”‚   â”‚   â”œâ”€â”€ game.types.ts              # Game state, round, mode types
â”‚   â”‚   â””â”€â”€ socket.types.ts            # Socket event payload types
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ permissions.ts             # Request sensor/fullscreen permissions
â”‚       â”œâ”€â”€ constants.ts               # Colors, thresholds, config
â”‚       â””â”€â”€ formatters.ts              # Display helpers (time, health %)
â”‚
â”œâ”€â”€ public/
â”‚   â””â”€â”€ sounds/
â”‚       â”œâ”€â”€ music/
â”‚       â”‚   â”œâ”€â”€ lobby-music.mp3
â”‚       â”‚   â”œâ”€â”€ tension-medium.mp3
â”‚       â”‚   â”œâ”€â”€ tension-high.mp3
â”‚       â”‚   â””â”€â”€ victory.mp3
â”‚       â”œâ”€â”€ effects/
â”‚       â”‚   â”œâ”€â”€ damage.mp3
â”‚       â”‚   â”œâ”€â”€ death.mp3
â”‚       â”‚   â””â”€â”€ low-health-heartbeat.mp3
â”‚       â””â”€â”€ voice/
â”‚           â””â”€â”€ role-reveal.mp3
â”‚
â”œâ”€â”€ index.html
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ package.json
```

---

## ğŸ”§ Configuration Files

### `vite.config.ts`

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  server: {
    port: 5173,
    proxy: {
      "/api": {
        target: "http://localhost:3000",
        changeOrigin: true,
      },
      "/socket.io": {
        target: "http://localhost:3000",
        changeOrigin: true,
        ws: true,
      },
    },
  },
  build: {
    outDir: "dist",
    sourcemap: true,
  },
});
```

### `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### `tailwind.config.js`

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      colors: {
        "health-healthy": {
          from: "#065f46",
          to: "#047857",
        },
        "health-damaged": {
          from: "#92400e",
          to: "#d97706",
        },
        "health-critical": {
          from: "#7f1d1d",
          to: "#dc2626",
        },
        "health-dead": "#1f2937",
        invulnerable: {
          from: "#e5e5e5",
          to: "#ffffff",
        },
        bloodlust: {
          from: "#450a0a",
          to: "#dc2626",
        },
      },
      keyframes: {
        pulse: {
          "0%, 100%": { opacity: 0.8 },
          "50%": { opacity: 1 },
        },
        heartbeat: {
          "0%, 100%": { transform: "scale(1)" },
          "10%": { transform: "scale(1.1)" },
          "20%": { transform: "scale(1)" },
        },
      },
      animation: {
        pulse: "pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite",
        heartbeat: "heartbeat 0.8s ease-in-out infinite",
      },
    },
  },
  plugins: [],
};
```

### `package.json`

```json
{
  "name": "extended-joust-client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint src --ext ts,tsx"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "socket.io-client": "^4.6.1",
    "zustand": "^4.4.7",
    "howler": "^2.2.4",
    "framer-motion": "^10.16.16",
    "lucide-react": "^0.300.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.45",
    "@types/react-dom": "^18.2.18",
    "@types/howler": "^2.2.11",
    "@vitejs/plugin-react": "^4.2.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.8",
    "tailwindcss": "^3.4.0",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "eslint": "^8.56.0"
  }
}
```

---

## ğŸ¯ Implementation Order

### Phase 1: Core Services & State (No UI)

**Goal**: Set up all logic layer before touching UI

1. **Types** (`src/types/`)

   - `player.types.ts` - Player, MovementData, PlayerState
   - `game.types.ts` - GameState, GameMode, Round
   - `socket.types.ts` - Event payloads

2. **Constants** (`src/utils/constants.ts`)

   - Health colors
   - Health thresholds
   - Player number sizes
   - API endpoints

3. **Socket Service** (`src/services/socket.ts`)

   - Socket.IO client initialization
   - Event handlers (stub implementations)
   - Reconnection logic
   - Heartbeat ping/pong

4. **API Service** (`src/services/api.ts`)

   - HTTP client wrapper
   - GET /game/modes
   - POST /game/create
   - GET /game/state
   - Error handling

5. **Accelerometer Service** (`src/services/accelerometer.ts`)

   - Request permission
   - DeviceMotionEvent listener
   - Data normalization (-10 to +10 range)
   - Throttling to 10Hz

6. **Audio Manager** (`src/services/audio.ts`)

   - Howler.js setup
   - Preload sounds
   - Play/loop/stop methods
   - Music ducking
   - TTS integration

7. **Game Store** (`src/store/gameStore.ts`)

   - Zustand state management
   - Player state
   - Game state
   - Connection state
   - Actions (updatePlayer, setGameState, etc.)

8. **Custom Hooks** (`src/hooks/`)
   - `useSocket.ts` - Socket connection + event handlers
   - `useAccelerometer.ts` - Motion data with throttling
   - `useWakeLock.ts` - Screen wake lock
   - `useFullscreen.ts` - Fullscreen API
   - `useAudio.ts` - Audio manager wrapper
   - `useReconnect.ts` - Auto-reconnection

### Phase 2: UI Components

9. **Router Setup** (`src/App.tsx`)

   - React Router
   - Routes: `/join`, `/player`, `/dashboard`

10. **Join View** (`src/pages/JoinView.tsx`)

    - Name input form
    - Join button
    - Error handling

11. **Player View** (`src/pages/PlayerView.tsx`)

    - Lobby state
    - Active game state
    - Dead state
    - Portrait lock

12. **Dashboard View** (`src/pages/DashboardView.tsx`)
    - Player grid
    - Admin controls
    - Event feed
    - Leaderboard

### Phase 3: Polish & Testing

13. **Animations** (Framer Motion)

    - Death transitions
    - Pulse effects
    - Smooth state changes

14. **Audio Integration**

    - Wire up all sound effects
    - Music transitions
    - TTS announcements

15. **Mobile Optimizations**
    - Wake lock
    - Fullscreen
    - Battery considerations

---

## ğŸ“ Implementation Notes

### Mobile Permissions

```typescript
// src/utils/permissions.ts

export async function requestMotionPermission(): Promise<boolean> {
  // iOS 13+ requires user gesture + permission
  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof (DeviceMotionEvent as any).requestPermission === "function"
  ) {
    try {
      const permission = await (DeviceMotionEvent as any).requestPermission();
      return permission === "granted";
    } catch (error) {
      console.error("Motion permission denied:", error);
      return false;
    }
  }

  // Android and older iOS: no permission needed
  return true;
}

export async function requestWakeLock(): Promise<boolean> {
  if (!("wakeLock" in navigator)) {
    console.warn("Wake Lock API not supported");
    return false;
  }

  try {
    const wakeLock = await (navigator as any).wakeLock.request("screen");
    console.log("Wake Lock acquired");
    return true;
  } catch (error) {
    console.error("Wake Lock failed:", error);
    return false;
  }
}

export async function requestFullscreen(
  element: HTMLElement
): Promise<boolean> {
  if (!element.requestFullscreen) {
    console.warn("Fullscreen API not supported");
    return false;
  }

  try {
    await element.requestFullscreen();
    return true;
  } catch (error) {
    console.error("Fullscreen failed:", error);
    return false;
  }
}
```

### Reconnection Flow

```typescript
// src/hooks/useReconnect.ts

export function useReconnect() {
  const [isReconnecting, setIsReconnecting] = useState(false);
  const [attempts, setAttempts] = useState(0);
  const maxAttempts = 5;

  useEffect(() => {
    socket.on("disconnect", () => {
      setIsReconnecting(true);
      setAttempts(0);

      const token = localStorage.getItem("sessionToken");
      if (!token) return;

      const interval = setInterval(() => {
        if (attempts >= maxAttempts) {
          clearInterval(interval);
          setIsReconnecting(false);
          // Show "Could not reconnect" error
          return;
        }

        socket.emit("player:reconnect", {
          token,
          socketId: socket.id,
        });

        setAttempts((prev) => prev + 1);
      }, 2000);
    });

    socket.on("player:reconnected", (data) => {
      if (data.success) {
        setIsReconnecting(false);
        setAttempts(0);
      }
    });
  }, [attempts]);

  return { isReconnecting, attempts };
}
```

### Battery Optimization

```typescript
// In PlayerView.tsx

useEffect(() => {
  if (!isAlive) {
    // Stop accelerometer updates
    accelerometer.stop();

    // Stop sending movement data
    socket.off("player:move");

    // Show static dead screen
    setShowDeadScreen(true);
  }
}, [isAlive]);
```

---

## ğŸš€ Getting Started

### Development Setup

```bash
# Install dependencies
cd client
npm install

# Start dev server (runs on :5173)
npm run dev

# In another terminal, start backend
cd ../server
npm run dev
```

### Production Build

```bash
# Build frontend
cd client
npm run build
# Output: client/dist/

# Backend will serve from dist/
cd ../server
npm run build
npm start
```

---

## âœ… Testing Checklist

### Functional Testing

- [ ] Player can join lobby with valid name
- [ ] Player receives unique player number (1-20)
- [ ] Session token stored in localStorage
- [ ] Player view shows correct state (lobby/active/dead)
- [ ] Accelerometer data throttled to 10Hz
- [ ] Socket.IO reconnection works within 10s
- [ ] Dashboard shows all connected players
- [ ] Dashboard can start game
- [ ] Role assignment works (private TTS)
- [ ] Health background changes correctly
- [ ] Dead players show skull screen
- [ ] Round transitions work
- [ ] Final leaderboard shows correct scores

### Audio Testing

- [ ] Background music plays in lobby
- [ ] Music transitions on round start
- [ ] TTS announcements duck music
- [ ] Player hears role reveal via earbud
- [ ] Damage sound plays on every tick
- [ ] Low health heartbeat starts <30%
- [ ] Death sound plays on elimination
- [ ] Victory music plays on round end

### Mobile Testing

- [ ] Accelerometer works on iOS (HTTPS)
- [ ] Wake lock keeps screen on
- [ ] Portrait lock overlay shows in landscape
- [ ] Fullscreen mode works (Android)
- [ ] Battery doesn't drain when dead
- [ ] Reconnection works after WiFi drop
- [ ] App works with one earbud

### Performance Testing

- [ ] No frame drops during gameplay
- [ ] 60fps animations
- [ ] No memory leaks over 30min session
- [ ] Smooth with 20 players
- [ ] Dashboard updates at 10Hz without lag

---

## ğŸ”’ Security Considerations

1. **Input Validation**: All accelerometer data validated server-side
2. **Session Tokens**: Random strings, 10s expiry after disconnect
3. **Rate Limiting**: Max 20Hz movement data (enforced server-side)
4. **No Sensitive Data**: Roles not sent to other players
5. **Admin Actions**: Dashboard-only endpoints (future: auth)

---

## ğŸ“¦ Dependencies Justification

| Package            | Why We Need It                                   |
| ------------------ | ------------------------------------------------ |
| `react`            | UI framework                                     |
| `react-router-dom` | Client-side routing (/join, /player, /dashboard) |
| `socket.io-client` | Real-time communication with server              |
| `zustand`          | Global state management (simpler than Redux)     |
| `howler`           | Cross-browser audio (better than Web Audio API)  |
| `framer-motion`    | Smooth animations (death, pulses)                |
| `lucide-react`     | Icon library (connection status, etc.)           |
| `tailwindcss`      | Utility-first CSS (rapid UI development)         |

---

**END OF SPECIFICATION**

Ready to start implementation! ğŸš€
